<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Estilos -->
    <link rel="stylesheet" href="style.css">

    <title>TI Caldlaser - Sistema de Tickets</title>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé´ Sistema de Chamados TI</h1>
            <p class="subtitle">Caldlaser - Suporte N√≠vel 1</p>
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span id="statusAPI">Efetuando a cone√ß√£o...</span>
        </div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="openTab(event, 'aba-novo')">
                üöÄ Novo Ticket
            </div>
            <div class="tab" onclick="openTab(event, 'aba-historico')">
                üîç Hist√≥rico
            </div>
            <div class="tab" onclick="openTab(event, 'aba-gestao')">
                ‚öôÔ∏è Gest√£o
            </div>
        </div>

        <!-- ABA NOVO TICKET -->
        <div id="aba-novo" class="tab-content active">
    <div class="card">
        <h2 style="margin-bottom: 25px; color: var(--text);">üìù Abrir Novo Chamado</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="usuario">üë§ Nome do Solicitante *</label>
                <input type="text" id="usuario" placeholder="Coloque seu nome">
            </div>

            <div class="form-group">
                <label for="email">üìß Seu E-mail *</label>
                <input type="email" id="email" placeholder="seu.email@caldlaser.com.br">
                <small style="color: #6b7280; font-size: 0.85rem;">Receba atualiza√ß√µes aqui</small>
            </div>

            <div class="form-group">
                <label for="setor">üè¢ Setor *</label>
                <select id="setor">
                    <option value="" disabled selected hidden></option>
                    <option value="administrativo" >Administrativo</option>
                    <option value="comercial">Comercial</option>
                    <option value="comercial">Compras</option>
                    <option value="diretoria">Diretoria</option>
                    <option value="fiscal">Fiscal</option>
                    <option value="laser">Laser</option>
                    <option value="melhoria">Melhoria Continua</option>
                    <option value="metpro">M√©todos e Processos</option>
                    <option value="pcp">PCP</option>
                    <option value="pintura">Pintura</option>
                    <option value="qualidade">Qualidade</option>
                    <option value="rh">Recursos Humanos</option>
                </select>
            </div>

            <div class="form-group">
                <label for="prioridade">‚ö° Prioridade *</label>
                <select id="prioridade">
                    <option value="" option value="" disabled selected hidden></option></option>
                    <option value="baixa">Baixa - Pode aguardar</option>
                    <option value="m√©dia">M√©dia - Normal</option>
                    <option value="alta">Alta - Urgente</option>
                    <option value="cr√≠tica">Cr√≠tica - Impacto severo</option>
                </select>
            </div>

            <div class="form-group full-width">
                <label for="descricao">üìã Descri√ß√£o do Problema *</label>
                <textarea id="descricao" rows="5" placeholder="Descreva detalhadamente o problema..."></textarea>
            </div>

            <div class="full-width">
                <button onclick="enviarTicket()">
                    <span id="btnText">üöÄ Abrir Ticket</span>
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- ABA HIST√ìRICO -->
        <div id="aba-historico" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="color: var(--text); margin: 0;">üìö Hist√≥rico de Tickets</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportarParaExcel()" style="background: var(--success); padding: 10px 20px; width: auto;">
                            üìä Exportar Excel
                        </button>
                        <button onclick="limparHistorico()" style="background: var(--danger); padding: 10px 20px; width: auto;">
                            üóëÔ∏è Limpar Hist√≥rico
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tabelaHistorico">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Usu√°rio</th>
                                <th>Setor</th>
                                <th>Prioridade</th>
                                <th>Status</th>
                                <th>Descri√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA GEST√ÉO -->
        <div id="aba-gestao" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 25px; color: var(--text);">‚öôÔ∏è Gest√£o de Tickets</h2>
                <div class="table-container">
                    <table id="tabelaGestao">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Prioridade</th>
                                <th>Usu√°rio</th>
                                <th>Setor</th>
                                <th>Descri√ß√£o</th>
                                <th>Status</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://tickets-caldlaser.vercel.app/";
        let apiOnline = false;
        let verificandoAPI = false;

        // Verificar status da API com retry
        async function verificarAPI(tentativa = 0) {
            if (verificandoAPI) return; // Evita m√∫ltiplas verifica√ß√µes simult√¢neas
            
            verificandoAPI = true;
            const maxTentativas = 3;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos timeout
                
                const res = await fetch(`${API_URL}/`, { 
                    signal: controller.signal,
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (res.ok) {
                    const data = await res.json();
                    apiOnline = true;
                    document.getElementById('statusAPI').textContent = ` Conectado - ${data.sistema}`;
                    document.querySelector('.status-dot').style.background = 'var(--success)';
                    verificandoAPI = false;
                    return true;
                }
            } catch (e) {
                console.log(`Tentativa ${tentativa + 1} de ${maxTentativas} falhou:`, e.message);
                
                if (tentativa < maxTentativas - 1) {
                    // Tentar novamente ap√≥s 1 segundo
                    verificandoAPI = false;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return verificarAPI(tentativa + 1);
                }
            }
            
            // Todas as tentativas falharam
            apiOnline = false;
            document.getElementById('statusAPI').textContent = '‚ùå Servidor Offline - Inicie o backend';
            document.querySelector('.status-dot').style.background = 'var(--danger)';
            verificandoAPI = false;
            return false;
        }

        // Trocar de aba
        async function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            // Recarregar dados ao trocar de aba (se API estiver online)
            if (apiOnline) {
                await carregarDados();
            } else {
                console.log('‚è∏Ô∏è API offline - dados n√£o carregados');
            }
        }

        // Carregar dados das tabelas
        async function carregarDados() {
            if (!apiOnline) {
                console.log('‚è∏Ô∏è API offline - aguardando conex√£o...');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/tickets`, {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const tickets = await res.json();

                // Hist√≥rico (todos os tickets, mais recentes primeiro)
                const tbodyH = document.querySelector("#tabelaHistorico tbody");
                tbodyH.innerHTML = "";
                
                if (tickets.length === 0) {
                    tbodyH.innerHTML = `
                        <tr><td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Nenhum ticket encontrado</p>
                        </td></tr>
                    `;
                } else {
                    tickets.slice().reverse().forEach(t => {
                        const cor = getStatusClass(t.status);
                        const priorityClass = `priority-${t.prioridade.toLowerCase()}`;
                        tbodyH.innerHTML += `
                            <tr>
                                <td><strong>#${t.id}</strong></td>
                                <td>${t.data}</td>
                                <td>${t.usuario}</td>
                                <td>${t.setor}</td>
                                <td><span class="priority-badge ${priorityClass}">${t.prioridade}</span></td>
                                <td><span class="badge ${cor}">${t.status}</span></td>
                                <td>${truncateText(t.descricao, 50)}</td>
                            </tr>
                        `;
                    });
                }

                // Gest√£o (apenas tickets n√£o conclu√≠dos)
                const tbodyG = document.querySelector("#tabelaGestao tbody");
                tbodyG.innerHTML = "";
                const ticketsAtivos = tickets.filter(t => t.status !== 'conclu√≠do');
                
                if (ticketsAtivos.length === 0) {
                    tbodyG.innerHTML = `
                        <tr><td colspan="7" class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>Todos os tickets foram conclu√≠dos!</p>
                        </td></tr>
                    `;
                } else {
                    ticketsAtivos.forEach(t => {
                        const cor = getStatusClass(t.status);
                        const priorityClass = `priority-${t.prioridade.toLowerCase()}`;
                        tbodyG.innerHTML += `
                            <tr>
                                <td><strong>#${t.id}</strong></td>
                                <td><span class="priority-badge ${priorityClass}">${t.prioridade}</span></td>
                                <td>${t.usuario}</td>
                                <td>${t.setor}</td>
                                <td>${truncateText(t.descricao, 40)}</td>
                                <td><span class="badge ${cor}">${t.status}</span></td>
                                <td>
                                    <select class="action-select" onchange="alterarStatus(${t.id}, this.value)">
                                        <option value="">Mudar status...</option>
                                        <option value="em andamento">‚è≥ Em Andamento</option>
                                        <option value="conclu√≠do">‚úÖ Concluir</option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (e) {
                console.error('Erro ao carregar dados:', e);
                // Se falhar, marcar API como offline e verificar novamente
                apiOnline = false;
                await verificarAPI();
            }
        }

        // Enviar novo ticket
        async function enviarTicket() {
            const user = document.getElementById("usuario").value.trim();
            const email = document.getElementById("email").value.trim();
            const desc = document.getElementById("descricao").value.trim();
            
            if (!user || !email || !desc) {
                mostrarAlerta('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Valida√ß√£o b√°sica de e-mail
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                mostrarAlerta('‚ö†Ô∏è Por favor, insira um e-mail v√°lido!', 'error');
                return;
            }

            if (!apiOnline) {
                mostrarAlerta('‚ùå Servidor offline. N√£o √© poss√≠vel criar ticket.', 'error');
                return;
            }

            // Desabilitar bot√£o durante envio
            const btn = document.querySelector('#aba-novo button');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> Enviando...';

            try {
                const res = await fetch(`${API_URL}/tickets`);
                const lista = await res.json();
                const novoId = lista.length > 0 ? Math.max(...lista.map(t => t.id)) + 1 : 1;
                
                const dados = {
                    id: novoId,
                    data: new Date().toLocaleString('pt-BR'),
                    usuario: user,
                    email_usuario: email,
                    setor: document.getElementById("setor").value,
                    categoria: "geral",
                    prioridade: document.getElementById("prioridade").value,
                    descricao: desc,
                    status: "aberto"
                };

                const response = await fetch(`${API_URL}/tickets`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    mostrarAlerta(`‚úÖ Ticket #${novoId} criado com sucesso! Voc√™ receber√° atualiza√ß√µes em ${email}`, 'success');
                    
                    // Limpar formul√°rio
                    document.getElementById("usuario").value = '';
                    document.getElementById("email").value = '';
                    document.getElementById("descricao").value = '';
                    
                    // Atualizar dados
                    setTimeout(() => carregarDados(), 1000);
                }
            } catch (e) {
                console.error('Erro ao enviar ticket:', e);
                mostrarAlerta('‚ùå Erro ao criar ticket', 'error');
            } finally {
                // Reabilitar bot√£o
                btn.disabled = false;
                btnText.innerHTML = 'üöÄ Abrir Ticket';
            }
        }

        // Alterar status do ticket
        async function alterarStatus(id, novoStatus) {
            if (!novoStatus) return;
            
            if (!confirm(`Deseja alterar o status do ticket #${id} para "${novoStatus}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/tickets/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: novoStatus })
                });

                if (response.ok) {
                    mostrarAlerta(`‚úÖ Status do ticket #${id} atualizado! Notifica√ß√µes enviadas.`, 'success');
                    setTimeout(() => carregarDados(), 1000);
                } else {
                    mostrarAlerta('‚ùå Erro ao atualizar status', 'error');
                }
            } catch (e) {
                console.error('Erro ao alterar status:', e);
                mostrarAlerta('‚ùå Erro ao atualizar ticket', 'error');
            }
        }

        // Fun√ß√µes auxiliares
        function getStatusClass(status) {
            if (status === 'aberto') return 'bg-aberto';
            if (status === 'em andamento') return 'bg-andamento';
            return 'bg-concluido';
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function mostrarAlerta(mensagem, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.innerHTML = `<strong>${mensagem}</strong>`;
            
            document.querySelector('.container').insertBefore(
                alertDiv, 
                document.querySelector('.tabs')
            );
            
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Exportar tickets para Excel
        async function exportarParaExcel() {
            try {
                const res = await fetch(`${API_URL}/tickets`);
                const tickets = await res.json();
                
                if (tickets.length === 0) {
                    mostrarAlerta('‚ö†Ô∏è N√£o h√° tickets para exportar!', 'error');
                    return;
                }

                // Criar conte√∫do CSV
                let csv = '\uFEFF'; // BOM para UTF-8
                csv += 'ID,Data,Usu√°rio,Email,Setor,Prioridade,Status,Descri√ß√£o\n';
                
                tickets.forEach(t => {
                    csv += `${t.id},"${t.data}","${t.usuario}","${t.email_usuario || ''}","${t.setor}","${t.prioridade}","${t.status}","${t.descricao.replace(/"/g, '""')}"\n`;
                });

                // Criar arquivo e fazer download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                link.setAttribute('href', url);
                link.setAttribute('download', `tickets_caldlaser_${dataAtual}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarAlerta(`‚úÖ ${tickets.length} tickets exportados com sucesso!`, 'success');
            } catch (e) {
                console.error('Erro ao exportar:', e);
                mostrarAlerta('‚ùå Erro ao exportar dados', 'error');
            }
        }

        // Limpar hist√≥rico de tickets
        async function limparHistorico() {
            try {
                const res = await fetch(`${API_URL}/tickets`);
                const tickets = await res.json();
                
                if (tickets.length === 0) {
                    mostrarAlerta('‚ö†Ô∏è N√£o h√° tickets para limpar!', 'error');
                    return;
                }

                const confirmacao = confirm(
                    `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                    `Voc√™ est√° prestes a excluir PERMANENTEMENTE ${tickets.length} ticket(s).\n\n` +
                    `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
                    `Deseja exportar os dados antes de excluir?\n\n` +
                    `Clique em OK para EXPORTAR e depois EXCLUIR\n` +
                    `Clique em CANCELAR para apenas EXCLUIR`
                );

                if (confirmacao) {
                    // Exportar antes de limpar
                    await exportarParaExcel();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                const confirmacaoFinal = confirm(
                    `üî¥ CONFIRMA√á√ÉO FINAL\n\n` +
                    `Tem certeza que deseja excluir TODOS os ${tickets.length} tickets?\n\n` +
                    `Digite OK abaixo para confirmar.`
                );

                if (!confirmacaoFinal) {
                    mostrarAlerta('‚ùå Opera√ß√£o cancelada', 'error');
                    return;
                }

                // Fazer a requisi√ß√£o para limpar
                const response = await fetch(`${API_URL}/limpar-historico`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Hist√≥rico limpo com sucesso!', 'success');
                    await carregarDados();
                } else {
                    mostrarAlerta('‚ùå Erro ao limpar hist√≥rico', 'error');
                }
            } catch (e) {
                console.error('Erro ao limpar hist√≥rico:', e);
                mostrarAlerta('‚ùå Erro ao limpar hist√≥rico', 'error');
            }
        }

        // Inicializa√ß√£o
        (async function inicializar() {
            console.log('üöÄ Iniciando aplica√ß√£o...');
            
            // Verificar API primeiro
            const apiOk = await verificarAPI();
            
            if (apiOk) {
                console.log('‚úÖ API conectada, carregando dados...');
                await carregarDados();
            } else {
                console.warn('‚ö†Ô∏è API offline - os dados ser√£o carregados quando o servidor estiver dispon√≠vel');
            }
            
            // Verificar API periodicamente (a cada 30 segundos)
            setInterval(async () => {
                const estaOnline = await verificarAPI();
                // Se reconectou, recarregar dados
                if (estaOnline && !apiOnline) {
                    carregarDados();
                }
            }, 30000);
        })();
    </script>
</body>
</html>
